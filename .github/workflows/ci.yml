name: ci

on:
  push:
  pull_request:

jobs:
  linux-checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++ clang-format clang-tidy cppcheck

      - name: Configure
        run: |
          cmake -S . -B build \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_STRICT=ON \
            -DBUILD_TESTING=ON \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Build
        run: cmake --build build -j $(nproc)

      - name: Run Unit Tests
        run: |
          cd build
          ctest --output-on-failure

      - name: clang-format (check)
        run: |
          find src include tests -type f \( -name "*.cpp" -o -name "*.hpp" -o -name "*.h" \) -print0 \
            | xargs -0 clang-format --dry-run --Werror

      - name: clang-tidy
        run: |
          clang-tidy -p build $(find src tests -name "*.cpp")

      - name: cppcheck
        run: |
          cppcheck --project=build/compile_commands.json \
            -i build/_deps \
            --enable=warning,style,performance,portability \
            --error-exitcode=1 \
            --inline-suppr

      - name: Smoke test
        run: printf "exit\n" | ./build/mini_shell

  sanitizers:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake g++

      - name: Configure (ASan + UBSan)
        run: |
          cmake -S . -B build-san \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DENABLE_STRICT=ON \
            -DENABLE_SANITIZERS=ON

      - name: Build
        run: cmake --build build-san -j $(nproc)

      - name: Run Tests with Sanitizers
        env:
          ASAN_OPTIONS: detect_leaks=1:halt_on_error=1
          UBSAN_OPTIONS: halt_on_error=1:print_stacktrace=1
        run: |
          cd build-san
          ctest --output-on-failure

      - name: Smoke test (Sanitizers)
        run: printf "exit\n" | ./build-san/mini_shell

  macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: brew install cmake

      - name: Configure
        run: |
          cmake -S . -B build-macos \
            -DCMAKE_BUILD_TYPE=Release \
            -DENABLE_STRICT=ON

      - name: Build
        run: cmake --build build-macos -j $(sysctl -n hw.ncpu)

      - name: Run Tests
        run: |
          cd build-macos
          ctest --output-on-failure

      - name: Smoke test (macOS)
        run: printf "exit\n" | ./build-macos/mini_shell
